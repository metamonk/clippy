# Epic 2 Retrospective - Recording Foundation

**Date:** 2025-10-29
**Epic:** Epic 2 - Recording Foundation
**Facilitator:** Bob (Scrum Master)
**Participants:** Amelia (Dev), Winston (Architect), Murat (Test Architect), John (Product Manager)

---

## Executive Summary

Epic 2 successfully delivered native macOS recording capabilities with ScreenCaptureKit integration, real-time FFmpeg encoding, and multi-source audio capture. All 8 stories completed (100% delivery rate) with three major blockers resolved during execution. The bounded channel pattern (Novel Pattern 2) prevented memory bloat during long recordings, and modular service architecture enabled effective parallel development.

**Key Achievement:** Validated the most technically risky aspect of clippy - calling native macOS frameworks from Rust with real-time video/audio processing.

---

## Epic 2 Delivery Metrics

- **Stories Completed:** 8/8 (100%)
- **Blockers Encountered:** 3 (Send trait, system audio API, FFmpeg architecture)
- **Blockers Resolved:** 3/3 (100%)
- **Review Cycles:** Story 2.5 required 2 cycles (blocking issues resolved)
- **Technical Debt Items:** 2 low-priority polish items deferred
- **Business Outcomes:** ✅ Core recording workflow functional, ✅ Auto-import working, ✅ Foundation for Epic 4

---

## Part 1: Epic 2 Review

### What Worked Well

**Architecture and Design:**
- **Novel Pattern 2 (Bounded Channels)** - `mpsc::channel(30)` with backpressure prevented memory bloat during 10+ minute recordings. Memory remained stable under 500MB.
- **Service Modularity** - Separation of screen_capture, audio_capture, and ffmpeg_encoder allowed independent debugging and fixes. Send trait blocker in audio_capture didn't impact video pipeline.
- **Clear Acceptance Criteria** - 48 ACs across 8 stories provided unambiguous success criteria. Review issues (Story 2.5: H1 missing dependency, M1 edge case) had clear fixes.

**Implementation Success:**
- **Story 2.1 Permission Foundation** - Solid ScreenCaptureKit permission handling saved downstream issues
- **Auto-Import Workflow (Story 2.6)** - <2 second latency from recording stop to media library appearance
- **Webcam Recording (Stories 2.7-2.8)** - Reused FFmpeg pipeline patterns from screen recording, accelerating implementation

**Testing and Quality:**
- **Traceability Matrix** - All 48 ACs mapped to components and test strategies enabled comprehensive testing
- **Multi-Layer Testing** - Unit tests + integration tests + review process caught issues automated tests missed

### Challenges and Growth Areas

**Technical Blockers:**

1. **Send Trait Issue (Story 2.4)** - Audio capture service not Send-safe initially, blocking multi-threaded recording. Fixed with Arc<Mutex<>> refactor (4 hours debugging).

2. **System Audio API Complexity** - ScreenCaptureKit audio APIs poorly documented compared to video APIs. Required extensive Apple documentation reading and experimentation.

3. **FFmpeg Architecture Ambiguity** - Unclear whether to use ffmpeg-sidecar CLI vs ffmpeg-next bindings. Stdin pipe architecture required iteration to stabilize.

**Process Friction:**
- **Review Cycle Cost** - Story 2.5's second review added 1 day. Caught H1 (missing libc dependency) and M1 (null check edge case) issues that passed automated tests.
- **PoC Definition Ambiguity** - Story 2.1 AC said "capture single frame validates setup" but implementation returned placeholder data, punted to Story 2.2. Boundary unclear.
- **Integration Uncertainty** - Native macOS framework integration had higher uncertainty than pure Rust work. `screencapturekit` crate 0.3.6 still early, hit edges where crate didn't expose all SCStream features.

**Planning Gaps:**
- **Insufficient Technical Exploration** - Should have spiked FFmpeg stdin pipe integration before Story 2.3. 2-hour spike would have de-risked implementation.
- **Estimate Accuracy** - Stories 2.1-2.2 estimated at 8-12 hours, reality 16-20 hours due to ScreenCaptureKit learning curve and debugging.

### Insights and Learning

**Carry Forward:**
- **Bounded channels are default for real-time pipelines** - Any future frame capture, encoding, or streaming work should use bounded channels with explicit backpressure handling.
- **Review cycles are valuable but expensive** - More thorough self-review with edge cases and dependency checking reduces cycles.
- **Clear story handoffs matter** - When Story N outputs match Story N+1 inputs explicitly, integration is smooth (e.g., Story 2.5 → 2.6 auto-import trigger).
- **Manual testing acceptance for macOS APIs** - CI can't automate permission dialogs or ScreenCaptureKit. Manual testing checklists are regression safety nets.

**Patterns to Avoid:**
- **Underestimating native framework complexity** - Pad estimates by 50% for ScreenCaptureKit, AVFoundation, CoreAudio integration.
- **Placeholder implementations in "done" stories** - Story 2.1's `vec![0u8; frame_size]` placeholder should have been flagged as incomplete or explicitly marked as PoC scope.
- **Skipping technical spikes for novel patterns** - Front-load 2-4 hour exploration spikes to de-risk complex stories.

---

## Part 2: Next Epic Preparation

### Epic 3 Status & Epic 4 Dependencies

**Epic 3 Progress:**
- **Completed:** Stories 3.1-3.4 (Multi-track foundation, multiple clips, drag between tracks, split clip)
- **Remaining:** Stories 3.5-3.10 (Delete with ripple, zoom, snap, waveforms, volume, fade)
- **Blocker Status:** Epic 3 completion is a HARD BLOCKER for Epic 4. Multi-track timeline must handle PiP compositions before Epic 4 creates them.

**Epic 4 Dependencies on Epic 2:**
- ✅ ScreenCaptureKit screen capture pipeline (Stories 2.2-2.6) - Stable and production-ready
- ✅ AVFoundation webcam capture (Stories 2.7-2.8) - Functional, needs broader device testing
- ❌ **Recording orchestrator refactor required** - Current orchestrator is single-stream only. Story 4.6 (simultaneous screen+webcam) needs multi-stream coordination architecture.
- ❌ **FFmpeg overlay filter integration unknown** - Real-time PiP composition performance unvalidated. This is GO/NO-GO for Story 4.6 approach.

### Preparation Tasks for Epic 4

**Technical Setup (Critical Path):**

1. **Refactor Recording Orchestrator** (Owner: Winston + Amelia, Est: 2-3 days)
   - Design multi-stream coordination pattern
   - Separate Tokio tasks for screen + webcam capture
   - Compositor task for FFmpeg overlay filter integration
   - **Prerequisite for Story 4.6**

2. **Spike: FFmpeg Overlay Filter Performance** (Owner: Amelia, Est: 4 hours)
   - Test real-time compositing at 30 FPS
   - Benchmark on M1 and Intel Macs
   - Document GPU acceleration options
   - **GO/NO-GO DECISION POINT:** If can't maintain 30 FPS, pivot to post-recording composition

3. **Design 3-Audio-Track Architecture** (Owner: Winston, Est: 4 hours)
   - System audio + microphone + webcam mic independent tracks
   - FFmpeg muxing strategy for 3 audio streams
   - Feeds into Stories 4.3 and 4.7

**Testing Infrastructure:**

4. **Build Multi-Stream Test Fixtures** (Owner: Murat, Est: 4-6 hours)
   - Mock simultaneous capture sources
   - Frame synchronization validation helpers
   - Overlay composition correctness tests

5. **Create Manual PiP Test Scripts** (Owner: Murat, Est: 3 hours)
   - Various PiP positions (top-left, top-right, bottom-left, bottom-right)
   - Screen resolution changes, aspect ratios
   - Quality and latency validation checklist

**UI and Planning:**

6. **Design Recording Configuration UI** (Owner: John, Est: 2 hours)
   - Mockups for resolution dropdowns, FPS toggles
   - Audio source checkboxes
   - PiP position/size presets
   - Feeds into Story 4.2 implementation

**Documentation:**

7. **Document Epic 2 Learnings in ADRs** (Owner: Winston, Est: 2 hours)
   - Bounded channel pattern success (Novel Pattern 2)
   - ScreenCaptureKit integration lessons
   - FFmpeg stdin pipe architecture

**Total Prep Effort:** ~30-40 hours across team (~2-3 week prep sprint)

### Risks and Mitigation

**Risk 1: Real-time PiP Compositing Performance**
- **Risk:** FFmpeg overlay filter can't maintain 30 FPS on older Macs
- **Mitigation:** Spike performance early (week before Epic 4). If inadequate, fall back to post-recording composition (record separately, composite in editor)
- **Early Warning:** Spike shows <25 FPS sustained encoding with overlay

**Risk 2: Multi-Stream Architecture Complexity**
- **Risk:** Recording orchestrator refactoring more complex than 2-3 day estimate
- **Mitigation:** If refactoring exceeds 3 days, reassess all Epic 4 estimates upward by 25%
- **Early Warning:** Day 2 of refactoring and design not finalized

**Risk 3: User Expectations vs MVP Reality**
- **Risk:** PiP quality/polish doesn't meet expectations vs Loom
- **Mitigation:** Set clear Epic 4 MVP scope - functional PiP first, polish later iterations
- **Early Warning:** User feedback on Epic 4 early stories mentions "feels unfinished"

**Risk 4: Three Audio Tracks Complexity**
- **Risk:** Adding webcam mic as 3rd independent track requires significant audio service refactoring
- **Mitigation:** Include audio architecture design in orchestrator refactoring prep work (before Story 4.6)
- **Early Warning:** Audio design discussions unresolved after Winston's 4-hour design session

---

## Action Items

### Process Improvements

1. **Create Self-Review Checklist** (Owner: Amelia, By: Before next story)
   - Include: dependency audit, edge case validation, placeholder code check
   - Goal: Reduce review cycle iterations

2. **Add Dependency Audit to CI Pipeline** (Owner: Murat, By: Sprint 4 start)
   - Catch missing dependencies before review (addresses Story 2.5 H1 pattern)

3. **Improve PoC vs Production-Ready Definitions** (Owner: John, By: Epic 4 planning)
   - Explicitly document what's stubbed vs implemented in ACs
   - Prevents Story 2.1 ambiguity pattern

4. **Pad Native Framework Integration Estimates by 50%** (Owner: Bob, By: Epic 4 planning)
   - Apply to ScreenCaptureKit, AVFoundation, CoreAudio stories
   - Accounts for learning curve and debugging

### Technical Debt

1. **Story 2.1 Follow-up: Real Frame Capture** (Owner: Amelia, Priority: High)
   - Replace placeholder `vec![0u8; frame_size]` with real SCStream delegate
   - Tracked in Story 2.1 review findings (M2)
   - **Status:** Naturally completed by Story 2.2 implementation (already done)

2. **Refactor macOS Version Check to Native API** (Owner: Amelia, Priority: Medium)
   - Replace sw_vers command with NSProcessInfo
   - Story 2.1 review finding M3
   - Est: 2-4 hours

### Documentation

3. **Document Manual Testing Checklist for macOS APIs** (Owner: Murat, By: Sprint 4 start)
   - ScreenCaptureKit permission flow regression testing
   - Camera/microphone permission validation
   - Recording quality acceptance criteria
   - Serves as regression safety net for CI limitations

### Team Agreements

- ✅ **No placeholder implementations in "done" stories** - If code is stubbed, story stays in-progress or marked as PoC explicitly
- ✅ **Early technical spikes for novel patterns** - 2-4 hour spikes before complex stories reduce mid-story pivots
- ✅ **Explicit handoff contracts between stories** - Output of Story N must match expected input of Story N+1
- ✅ **Bounded channels as default for real-time pipelines** - Pattern proven in Epic 2, apply to future streaming work

---

## Critical Path for Epic 4

### Hard Blockers

1. **Epic 3 Must Be 100% Complete**
   - Owner: Amelia
   - Must complete by: Before Epic 4 Story 4.1
   - Rationale: Multi-track timeline must handle PiP compositions. Story 3.10 (Audio Fade) validates FFmpeg filter pipeline Epic 4 needs.

2. **FFmpeg Overlay Spike Must Prove Feasibility**
   - Owner: Amelia
   - Must complete by: Week before Epic 4
   - Success Criteria: Real-time compositing at 30 FPS on M1 Macs
   - **GO/NO-GO DECISION:** If fails, pivot to post-recording composition

3. **Recording Orchestrator Refactored**
   - Owner: Winston + Amelia
   - Must complete by: Before Story 4.6
   - Success Criteria: Multi-stream coordination architecture implemented and tested with mock sources

### Dependencies Timeline

```
Now
  ↓
Complete Epic 3 (Stories 3.5-3.10) → 2-3 weeks
  ↓
FFmpeg Overlay Spike (4 hours) → GO/NO-GO Decision
  ↓
Epic 4 Prep Sprint (Prerequisites) → 2-3 weeks
  ↓
Epic 4 Story 4.1 (Window Selection) → Ready to Start
```

---

## Readiness Assessment

**Testing and Quality:** ✅ Complete
- All 8 stories tested and validated
- Story 2.5 passed Review Cycle 2 with blocking issues resolved
- Manual testing completed for permission flows and recording quality
- **Caveat:** Limited hardware testing (M1 Macs primarily). Wider testing would increase confidence.

**Deployment and Release:** ✅ Clear Plan
- Epic 2 integrated in main branch, functional in development builds
- Will be included in next packaged release with Epic 3 completion
- No external deployment blockers

**Stakeholder Acceptance:** ✅ Achieved
- Internal stakeholder (zeno) validated all Epic 2 features
- Feedback positive: recording workflow smooth, auto-import UX good, webcam quality acceptable
- No change requests pending

**Technical Health:** ✅ Stable
- Codebase clean with well-separated services
- Error handling consistent (thiserror patterns)
- State management sound (Zustand frontend, Tauri backend)
- Technical debt tracked and prioritized (2 low-priority items)

**Unresolved Blockers:** ✅ None
- Send trait issue (Story 2.4) - Resolved with Arc<Mutex<>>
- System audio API complexity - Resolved with documentation
- FFmpeg architecture - ffmpeg-sidecar working, stdin pipe stable

**Verdict:** Epic 2 is production-ready for prototype phase. Recommended wider hardware testing before public release, but foundation is solid.

---

## Key Takeaways Summary

1. **Architectural wins pay dividends** - Bounded channels prevented memory bloat, modular services enabled parallel debugging
2. **Clear requirements reduce rework** - 48 specific ACs provided unambiguous success criteria
3. **Native framework integration is harder than expected** - Pad estimates by 50% for macOS APIs
4. **Review cycles catch critical issues** - Story 2.5 issues would have shipped without thorough review
5. **Technical spikes de-risk complex stories** - 2-4 hour exploration before novel patterns prevents mid-story pivots
6. **Manual testing is essential for macOS APIs** - CI limitations require documented manual regression checklists

---

## Next Steps

1. ✅ **Complete Epic 3** (6 stories remaining: 3.5-3.10)
2. ⏳ **Execute Epic 4 Prep Sprint** (Est: 2-3 weeks, 30-40 hours)
   - FFmpeg overlay performance spike (GO/NO-GO decision)
   - Refactor recording orchestrator for multi-stream
   - Build test infrastructure for PiP
   - Design 3-audio-track architecture
3. ⏳ **Review action items in next standup**
   - Self-review checklist, dependency CI audit, manual testing docs
4. ⏳ **Begin Epic 4 planning when prep complete**
   - Story 4.1 (Window Selection) ready after prep sprint
   - Full Epic 4 execution after Epic 3 + prep sprint complete

---

**Retrospective Status:** ✅ Completed
**Retrospective Saved:** `/Users/zeno/Projects/clippy/project/docs/retrospectives/epic-2-retro-2025-10-29.md`
**Next Retrospective:** After Epic 3 completion (or Epic 4 completion)
